<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>CyberQuest Admin - ×”××¢×¨×›×ª ×”××œ××”</title>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --sidebar-bg: #1e293b; --main-bg: #f8fafc; --accent: #38bdf8; --error: #ef4444; --success: #10b981; }
        body { font-family: 'Assistant', sans-serif; margin: 0; display: flex; background: var(--main-bg); min-height: 100vh; }
        
        /* Login Area */
        #loginArea { position: fixed; inset: 0; background: var(--sidebar-bg); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .login-card { background: white; padding: 40px; border-radius: 15px; text-align: center; width: 320px; transition: 0.3s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        .shake { animation: shake 0.2s ease-in-out 0s 2; border: 2px solid var(--error) !important; }

        /* Sidebar */
        .sidebar { width: 260px; background: var(--sidebar-bg); color: white; padding: 20px; position: fixed; height: 100vh; }
        .tab-btn { display: block; width: 100%; padding: 15px; margin-bottom: 8px; border: none; background: none; color: #94a3b8; text-align: right; cursor: pointer; border-radius: 8px; font-size: 1rem; transition: 0.3s; }
        .tab-btn.active { background: var(--accent); color: var(--sidebar-bg); font-weight: bold; }

        /* Main Content */
        .main-panel { margin-right: 260px; flex: 1; padding: 40px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .hidden { display: none; }
        
        /* Forms */
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #e2e8f0; border-radius: 8px; font-family: inherit; font-size: 1rem; box-sizing: border-box; }
        textarea { height: 100px; resize: vertical; white-space: pre-wrap; }
        button { background: var(--accent); color: var(--sidebar-bg); border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; width: 100%; }
        button:hover { opacity: 0.9; }
        
        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { text-align: right; padding: 15px; border-bottom: 1px solid #f1f5f9; white-space: pre-wrap; }
        .score-v { color: var(--success); font-weight: bold; }
        .score-x { color: var(--error); font-weight: bold; }
    </style>
</head>
<body>

<div id="loginArea">
    <div class="login-card" id="loginCard">
        <h2 style="margin-top:0">×›× ×™×¡×ª ×× ×”×œ×ª</h2>
        <div style="position: relative; width: 100%;">
            <input type="password" id="adminPass" placeholder="×¡×™×¡××ª × ×™×”×•×œ" style="padding-left: 45px;">
            <span id="togglePass" onclick="togglePasswordVisibility()" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1.2rem;">ğŸ‘ï¸</span>
        </div>
        <p id="errorMsg" style="color: var(--error); font-size: 0.85rem; margin-top: 5px; display: none;">×¡×™×¡××” ×©×’×•×™×”, × ×¡×™ ×©×•×‘.</p>
        <button onclick="login()" style="margin-top: 15px;">×›× ×™×¡×” ×œ××¢×¨×›×ª</button>
    </div>
</div>

<div class="sidebar">
    <h2 style="color: var(--accent); margin-bottom: 30px;">CyberQuest</h2>
    <button class="tab-btn active" onclick="showTab('qTab', this)">ğŸ“š × ×™×”×•×œ ×©××œ×•×ª</button>
    <button class="tab-btn" onclick="showTab('gradingTab', this)">ğŸ“ ×¦×™×•× ×™ ×—× ×™×›×™×</button>
    <button class="tab-btn" onclick="showTab('settingsTab', this)">ğŸ“º ×©×™×“×•×¨ ×•×”×’×“×¨×•×ª</button>
</div>

<div class="main-panel">
    <div id="qTab" class="tab-content">
        <div class="card">
            <h2>â• ×”×•×¡×¤×ª ×©××œ×” ×—×“×©×”</h2>
            <select id="qCatSelect"></select>
            <select id="qType" onchange="toggleOptions()">
                <option value="open">×©××œ×” ×¤×ª×•×—×” (Flag)</option>
                <option value="multiple">×©××œ×” ×××¨×™×§××™×ª</option>
            </select>
            <textarea id="qText" placeholder="×ª×•×›×Ÿ ×”×©××œ×”..."></textarea>
            
            <div id="optArea" class="hidden">
                <div id="ansList"></div>
                <button onclick="addOptionField()" style="background:#e2e8f0; color:#475569; width:auto; margin-bottom:10px;">+ ×”×•×¡×£ ××•×¤×¦×™×”</button>
            </div>
            
            <input id="qAns" placeholder="×”×ª×©×•×‘×” ×”× ×›×•× ×”">
            <button onclick="saveQuestion()">×©××•×¨ ×©××œ×” ×‘×××’×¨</button>
        </div>

        <div class="card">
            <h2>ğŸ” ×××’×¨ ×©××œ×•×ª</h2>
            <select id="filterCat" onchange="loadQuestions()"><option value="all">×›×œ ×”×§×˜×’×•×¨×™×•×ª</option></select>
            <table>
                <thead><tr><th>×©××œ×”</th><th>×ª×©×•×‘×”</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
                <tbody id="qTableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="gradingTab" class="tab-content hidden">
        <div class="card">
            <h2>ğŸ“Š ×ª×•×¦××•×ª ×•×‘×“×™×§×ª ××‘×—× ×™×</h2>
            <table>
                <thead><tr><th>×—× ×™×š</th><th>×©××œ×”</th><th>×ª×©×•×‘×”</th><th>×ª×•×¦××”</th><th>× ×™×§×•×“</th></tr></thead>
                <tbody id="subTable"></tbody>
            </table>
        </div>
    </div>

    <div id="settingsTab" class="tab-content hidden">
        <div class="card">
            <h2>ğŸ“º ×©×™×“×•×¨ ×¤×¢×™×œ</h2>
            <select id="activeCatSelect"></select>
            <button onclick="setActive()">×”×¤×¢×œ ×§×˜×’×•×¨×™×” ×œ×—× ×™×›×™×</button>
        </div>
        <div class="card">
            <h2>ğŸ“ × ×™×”×•×œ ×§×˜×’×•×¨×™×•×ª</h2>
            <input id="newCatName" placeholder="×©× ×§×˜×’×•×¨×™×”">
            <button onclick="addCat()">×”×•×¡×£ ×§×˜×’×•×¨×™×”</button>
        </div>
    </div>
</div>

<script>
    const BASE_URL = "https://osint-751d7-default-rtdb.europe-west1.firebasedatabase.app/"; 
    const PASS = "zigi2026";

    // ×œ×•×’×™×§×ª ×›× ×™×¡×”
    function togglePasswordVisibility() {
        const p = document.getElementById('adminPass');
        const i = document.getElementById('togglePass');
        p.type = p.type === 'password' ? 'text' : 'password';
        i.innerText = p.type === 'password' ? 'ğŸ‘ï¸' : 'ğŸ”’';
    }

    function login() {
        const p = document.getElementById('adminPass');
        const c = document.getElementById('loginCard');
        if(p.value === PASS) {
            document.getElementById('loginArea').classList.add('hidden');
            loadAll();
        } else {
            c.classList.add('shake');
            document.getElementById('errorMsg').style.display = 'block';
            p.value = "";
            setTimeout(() => c.classList.remove('shake'), 500);
        }
    }

    // × ×™×•×•×˜
    function showTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.remove('hidden');
        btn.classList.add('active');
        if(id === 'gradingTab') loadSubmissions();
    }

    // × ×™×”×•×œ ×©××œ×•×ª ×××¨×™×§××™×•×ª
    function toggleOptions() {
        document.getElementById('optArea').classList.toggle('hidden', document.getElementById('qType').value !== 'multiple');
    }
    function addOptionField() {
        const i = document.createElement('input');
        i.className = "opt-input";
        i.placeholder = "××•×¤×¦×™×”...";
        document.getElementById('ansList').appendChild(i);
    }

    // ×ª×§×©×•×¨×ª Firebase
    async function loadAll() {
        const res = await fetch(`${BASE_URL}categories.json`);
        const data = await res.json();
        ['qCatSelect', 'activeCatSelect', 'filterCat'].forEach(sId => {
            const s = document.getElementById(sId);
            s.innerHTML = sId === 'filterCat' ? '<option value="all">×›×œ ×”×§×˜×’×•×¨×™×•×ª</option>' : '';
            for(let id in data) s.innerHTML += `<option value="${data[id].name}">${data[id].name}</option>`;
        });
        loadQuestions();
    }

    async function saveQuestion() {
        const opts = Array.from(document.querySelectorAll('.opt-input')).map(i => i.value);
        const data = {
            category: document.getElementById('qCatSelect').value,
            type: document.getElementById('qType').value,
            text: document.getElementById('qText').value,
            answer: document.getElementById('qAns').value.trim(),
            options: opts
        };
        await fetch(`${BASE_URL}questions.json`, { method: 'POST', body: JSON.stringify(data) });
        alert("× ×©××¨!"); location.reload();
    }

    async function loadQuestions() {
        const res = await fetch(`${BASE_URL}questions.json`);
        const data = await res.json();
        const filter = document.getElementById('filterCat').value;
        const tbody = document.getElementById('qTableBody');
        tbody.innerHTML = "";
        for(let id in data) {
            if(filter !== 'all' && data[id].category !== filter) continue;
            tbody.innerHTML += `<tr><td>${data[id].text}</td><td>${data[id].answer}</td><td><button onclick="del('questions/${id}')" style="width:auto; background:#ff4444; color:white;">××—×§</button></td></tr>`;
        }
    }

    async function loadSubmissions() {
        const res = await fetch(`${BASE_URL}submissions.json`);
        const data = await res.json();
        const tbody = document.getElementById('subTable');
        tbody.innerHTML = "";
        for(let id in data) {
            const s = data[id];
            tbody.innerHTML += `<tr>
                <td>${s.student}</td>
                <td>${s.questionText.substring(0,30)}...</td>
                <td>${s.userAnswer}</td>
                <td class="${s.isCorrect?'score-v':'score-x'}">${s.isCorrect?'× ×›×•×Ÿ':'×©×’×•×™'}</td>
                <td><input type="number" value="${s.score||''}" onchange="setScore('${id}', this.value)" style="width:60px; margin:0;"></td>
            </tr>`;
        }
    }

    async function setScore(id, val) { await fetch(`${BASE_URL}submissions/${id}/score.json`, { method: 'PUT', body: JSON.stringify(val) }); }
    async function setActive() { await fetch(`${BASE_URL}settings.json`, { method: 'PUT', body: JSON.stringify({activeCategory: document.getElementById('activeCatSelect').value}) }); alert("×©×•×“×¨ ×œ×—× ×™×›×™×!"); }
    async function addCat() { await fetch(`${BASE_URL}categories.json`, { method: 'POST', body: JSON.stringify({name: document.getElementById('newCatName').value}) }); loadAll(); }
    async function del(path) { if(confirm('×œ××—×•×§?')) { await fetch(`${BASE_URL}${path}.json`, { method: 'DELETE' }); loadQuestions(); } }
</script>
</body>
</html>
